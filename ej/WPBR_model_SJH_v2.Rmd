---
title: "WPBR Model"
author: "Stephen Huysman"
date: "`r Sys.Date()`"
fontsize: 10pt 
output:
  html_document:
    toc: true
    toc_float: true
---

# Load Data
```{r}
library(daymetr)
library(tidyverse)
library(sf)
library(terra)
library(modelr)
library(elevatr)
library(janitor)
library(MuMIn)
library(GGally)
library(lme4)
library(ggeffects)
library(glue)

crs_wgs84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

parks <- read_csv("./SITE_LOCATIONS.csv")

##gridmet_data_dir <- "./out/elev_corrected"
gridmet_data_dir <- "./out/"

gridmet_files <- fs::dir_ls(path = gridmet_data_dir, glob = "*.csv")
   
gridmet_data <- vroom::vroom(gridmet_files, id = "transect_id", altrep = TRUE)

gridmet_data <- gridmet_data %>%
    select(-"...1") %>%
    filter(
        year(Date) >= 2000,
        year(Date) <= 2020
    ) %>%
    mutate(transect_id = str_extract(transect_id, regex(".*/(.*)\\.csv"), group = 1)) %>%
    filter(transect_id != "Butterfield") ## Issue pulling gridmet data for site

## gridmet_data_annual <- gridmet_data %>%
##     group_by(transect_id, year(Date)) %>%
##     summarize(max_T = max(T),
##               min_T = min(T),
##               max_P = max(P),
##               min_P = min(P),
##               max_VPD = max(VPD),
##               min_VPD = min(VPD),
##               max_RH = max(RH),
##               min_RH = min(RH)) %>%
##     group_by(transect_id) %>%
##     summarize(max_T = mean(max_T),
##               min_T = mean(min_T),
##               max_P = mean(max_P),
##               min_P = mean(min_P),
##               max_VPD = mean(max_VPD),
##               min_VPD = mean(min_VPD),
##               max_RH = mean(max_RH),
##               min_RH = mean(min_RH))

## A-S Climate
gridmet_data_as <- gridmet_data %>%
    filter(month(Date) == 8 | month(Date) == 9) %>%
    group_by(transect_id, year(Date)) %>%
    summarize(
        T = mean(T),
        ##T_cor = mean(T_cor),
        RH = mean(RH),
        VPD = sum(VPD),
        P = sum(P)
    ) %>% ## Annual asVPD sum
    group_by(transect_id) %>%
    summarize(
        asT = mean(T),
        ##asT_cor = mean(T_cor),
        asRH = mean(RH),
        asVPD = mean(VPD), ## Mean annual asVPD sum
        asP = mean(P) ## Mean annual P sum
    ) %>%
    mutate(
        re_asT = scales::rescale(asT, newrange = c(0, 1)),
        re_asRH = scales::rescale(asRH, newrange = c(0, 1)),
        re_asVPD = scales::rescale(asVPD, newrange = c(0, 1)),
        re_asP = scales::rescale(asP, newrange = c(0, 1))
    )


monitoring_data <- read_csv("./Complete_Site_Monitoring_Dataset.csv") %>%
    left_join(parks, by = c("network", "transect_id")) %>%
    filter(tree_species == "PIAL" | tree_species == "PINALB") %>%
    filter(transect_id != "Butterfield") %>% ## Issue pulling gridmet data for site
    filter(!is.na(dbh_cm), dbh_cm != 999, dbh_cm != -999, dbh_cm != Inf, dbh_cm != -Inf) %>%
    filter(dbh_cm > 0) %>% ## Not sure what 0 cm dbh means, about 189 trees dbh=0
    filter(!is.na(br_status))


mod_data_tree_level <- left_join(monitoring_data, gridmet_data_as, by = "transect_id")
    ## filter(!is.na(asT), !is.na(asRH), !is.na(asVPD)) ## filter sites with missing climate data



    ### Remove duplicate tree_id in transect.  Keep the first one found.
    mod_data_tree_level <- mod_data_tree_level %>%
##        filter(year >= 2003 & year <= 2020) %>%
##        filter(tree_status == "L") %>%
        arrange(desc(year)) %>% ### Keep transects from most recent year
        distinct(across(c(transect_id, tree_id)),
            .keep_all = TRUE
        ) %>%
        mutate(
            br_status = factor(br_status)
        )


mod_data_tree_level <- mod_data_tree_level %>%
##    left_join(gridmet_data_annual, by = "transect_id") %>%
    mutate(
        transect_id = factor(transect_id),
        park = factor(park),
        network = factor(network),
        log_dbh_cm = log(dbh_cm)
    )


### Convert lat longs to equidistant projection for sdmTMB spatial models
max_lat <- round(max(mod_data_tree_level$lat), 0)
min_lat <- round(min(mod_data_tree_level$lat), 0)
mid_lat <- round(mean(mod_data_tree_level$lat), 0)
mid_long <- round(mean(mod_data_tree_level$long), 0)

crs_lcc <- glue("+proj=lcc +lon_0={mid_long} +lat_1={min_lat} +lat_2={max_lat} +units=km")

mod_data_tree_level <- st_as_sf(mod_data_tree_level, coords = c("long", "lat"), crs = crs_wgs84)

mod_data_tree_level <- st_transform(mod_data_tree_level, crs = crs_lcc)

mod_data_tree_level <- bind_cols(mod_data_tree_level, st_coordinates(mod_data_tree_level)) %>% as_tibble()



#### Transect-level
mod_data_transect_level <- monitoring_data %>%
    arrange(desc(year)) %>% ### Keep transects from most recent year
    distinct(across(c(transect_id, tree_id)),
        .keep_all = TRUE
    ) %>%
    group_by(transect_id) %>%
    dplyr::summarize(
        inf_trees = sum(br_status),
        recent_br_status = cut(inf_trees,
            breaks = c(-1, 1, 200),
            labels = c(0, 1)
        )
    ) %>%
    left_join(gridmet_data_as, by = "transect_id") %>%
    left_join(parks, by = "transect_id") %>%
    mutate(
        transect_id = factor(transect_id),
        park = factor(park)
    )

mod_data_transect_level <- st_as_sf(mod_data_transect_level, coords = c("long", "lat"), crs = crs_wgs84)

mod_data_transect_level <- st_transform(mod_data_transect_level, crs = crs_lcc)

mod_data_transect_level <- bind_cols(mod_data_transect_level, st_coordinates(mod_data_transect_level)) %>% as_tibble()




# create a dataframe of infected and uninfected trees based on all observations
# rule 1: tree must be visited at least twice = 4 years between observations.  eliminates new trees since 2014
# rule 2: any visit marked as infected based on 3 indicators, ie. any visit "Y" for infected
# rule 3: any visit marked "N".  These are what's left after pulling "Y"'s in previous if then step
# the "any" Y or N aspect is important in deciding both Y and N status ultimately and it depends on the evaluation order here with Y's first
# NA almost always means tree died, so N's with NA's mean a tree was infected before it died

## monitoring_data <- read_csv("./Complete_Site_Monitoring_Dataset.csv") %>%
##     filter(year <= 2020) %>%
##     arrange(desc(year)) %>%
##     group_by(transect_id, tree_id)

## tree_counts <- monitoring_data %>%
##     group_by(transect_id, tree_id) %>%
##     summarize(n = n(),
##               network = network)


```

# A priori models
| Variable | Description               |
|----------|---------------------------|
| asT      | Aug/Sep Mean Temperature  |
| asRH     | Aug/Sep Mean RH           |
| asVPD    | Aug/Sep Sum of VPD        |
| asP      | Aug/Sep Sum of P          |
| dbh_cm   | Diameter at breast height |

- Location variables?

# EDA

```{r}
cols = c("br_status", "asT", "asVPD", "asRH", "asP", "dbh_cm", "log_dbh_cm")

ggpairs(mod_data_tree_level, columns = cols)

ggpairs(mod_data_tree_level, mapping = aes(color = park), columns = cols)

mod_data_tree_level %>%
    pivot_longer(cols = c(asVPD, asT, asRH, asP)) %>%
    filter(network != "fivepks") %>%
    ggplot(aes(x = value, y = br_status)) +
    geom_boxplot() +
    facet_wrap(~name, scales = "free")

mod_data_tree_level %>%
    pivot_longer(cols = c(asVPD, asT, asRH, asP)) %>%
    ggplot(aes(x = value, y = br_status)) +
    geom_boxplot() +
    facet_wrap(~name, scales = "free")

```

## Season Plot
Has Aug/September patters of climate shifted?

```{r}
monthly_climate <- gridmet_data %>%
    left_join(parks, by = "transect_id") %>%
    mutate(
        year = year(Date),
        month = month(Date)
    ) %>%
    group_by(year, month, park, transect_id) %>%
    summarize(
        P = sum(P),
        VPD = sum(VPD),
        RH = RH,
        T = T
    ) %>%
    group_by(year, month, park) %>%
    summarize(
        P = mean(P),
        T = mean(T),
        VPD = mean(VPD),
        RH = mean(RH),
        transect_id = transect_id
    )

ggplot(monthly_climate, mapping = aes(x = month, y = RH, color = year, group = year)) +
    geom_line() +
    scale_x_continuous(breaks = 1:12) +
    geom_vline(xintercept = 8) +
    geom_vline(xintercept = 10) +
    facet_wrap(~park)

ggplot(monthly_climate, mapping = aes(x = month, y = VPD, color = year, group = year)) +
    geom_line() +
    scale_x_continuous(breaks = 1:12) +
    geom_vline(xintercept = 8) +
    geom_vline(xintercept = 10) +
    facet_wrap(~park)

ggplot(monthly_climate, mapping = aes(x = month, y = T, color = year, group = year)) +
    geom_line() +
    scale_x_continuous(breaks = 1:12) +
    scale_color_viridis() +
    geom_vline(xintercept = 8) +
    geom_vline(xintercept = 10) +
    facet_wrap(~park)

ggplot(monthly_climate, mapping = aes(x = month, y = P, color = year, group = year)) +
    geom_line() +
    scale_x_continuous(breaks = 1:12) +
    scale_color_viridis() +
    geom_vline(xintercept = 8) +
    geom_vline(xintercept = 10) +
    facet_wrap(~park, scales = "free")
```

# Model Selection

## Test for Covariance
```{r}
glmer_all <- glmer(br_status ~ asT + asVPD + asRH + asP + dbh_cm + (1 | park) + (1 | park:transect_id),
                   data = mod_data_tree_level,
                   family = binomial
)

summary(glmer_all)

cor_table <- vcov(glmer_all) %>%
    cov2cor() %>%
    as.matrix()

cor_table %>%
    knitr::kable()

abs(cor_table) > 0.7

library(corrplot)
corrplot(cor(select(mod_data_tree_level, asT, asVPD, asP, asRH, dbh_cm)), method = "number", type = "upper")

corrplot(cor(select(mod_data_tree_level, max_T, min_T, max_P, min_P, max_VPD, min_VPD, max_RH, min_RH, dbh_cm)), method = "number", type = "upper")

```

Collinear variables (glmer_all):
asT, asVPD
asVPD, asRH

Corrplot:
asT, asVPD
asRH, asP
asVPD, asRH? = -0.57

## Only FE

``` r
glm_t <- glm(br_status ~ asT + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t)

glm_t_2 <- glm(br_status ~ poly(asT, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2)

## Square T?
anova(glm_t, glm_t_2, test = "Chisq")

glm_vpd <- glm(br_status ~ asVPD + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd)

glm_vpd_2 <- glm(br_status ~ poly(asVPD, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_2)

## Square VPD?
anova(glm_vpd, glm_vpd_2, test = "Chisq")


glm_rh <- glm(br_status ~ asRH + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_rh)

glm_rh_2 <- glm(br_status ~ poly(asRH, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_rh_2)

## square rh?
anova(glm_rh, glm_rh_2, test = "Chisq")


glm_p <- glm(br_status ~ asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_p)

glm_p_2 <- glm(br_status ~ poly(asP, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_p_2)

## Square P?
anova(glm_p, glm_p_2, test = "Chisq")


glm_t_rh <- glm(br_status ~ asT * asRH + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_rh)

glm_t_2_rh <- glm(br_status ~ poly(asT, 2) * asRH + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_rh)

anova(glm_t_rh, glm_t_2_rh, test = "Chisq")

glm_t_2_rh_2 <- glm(br_status ~ poly(asT, 2) * poly(asRH, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_rh_2)

anova(glm_t_2_rh, glm_t_2_rh_2, test = "Chisq")


glm_t_p <- glm(br_status ~ asT * asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_p)


glm_t_2_p <- glm(br_status ~ poly(asT, 2) * asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_p)

glm_t_2_p_2 <- glm(br_status ~ poly(asT, 2) * poly(asP, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_p_2)

anova(glm_t_2_p, glm_t_2_p_2, test = "Chisq")

glm_t_2_p_rh <- glm(br_status ~ poly(asT, 2) * asRH + asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_p_rh)

glm_p_rh <- glm(br_status ~ asP + asRH + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_p_rh)

glm_vpd_p <- glm(br_status ~ asVPD* asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_p)

glm_vpd_2_p <- glm(br_status ~ poly(asVPD, 2) * asP + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_2_p)

anova(glm_vpd_p, glm_vpd_2_p, test = "Chisq")

glm_vpd_2_p_2 <- glm(br_status ~ poly(asVPD, 2) * poly(asP, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_2_p_2)

glm_vpd_2_p_2_rh_2 <- glm(br_status ~ poly(asVPD, 2) * poly(asP, 2) * poly(asT, 2) + dbh_cm,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_2_p_2_rh_2)

anova(glm_vpd_2_p, glm_vpd_2_p_2, test = "Chisq")

glm_max_vpd_2 <- glm(br_status ~ poly(max_VPD, 2) + dbh_cm,
    data = mod_data_tree_level,
    family = binomial
)
summary(glm_max_vpd_2)

## model.sel(glm_t, glm_t_2, glm_rh, glm_p, glm_t_rh, glm_t_2_rh, glm_t_p, glm_t_2_p, glm_t_p_rh, glm_t_2_p_rh, glm_p_rh, glm_vpd, glm_vpd_2, glm_vpd_p, glm_vpd_2_p)

## First Order models
model.sel(glm_t,
          glm_rh,
          glm_p,
          glm_t_rh,
          glm_t_p,
          glm_vpd,
          glm_vpd_p)

## Second Order Models
model.sel(glm_t_2,
          glm_rh_2,
          glm_p_2,
          glm_t_2_rh_2,
          glm_t_2_p_2,
          glm_vpd_2,
          glm_vpd_2_p_2)

## All Models
model.sel(glm_t,
          glm_rh,
          glm_p,
          glm_t_rh,
          glm_t_p,
          glm_vpd,
          glm_vpd_p,
          glm_t_2,
          glm_rh_2,
          glm_p_2,
          glm_t_2_rh_2,
          glm_t_p,
          glm_t_2_p,
          glm_vpd_2,
          glm_vpd_2_p,
          glm_vpd_2_p_2)


### No P
## First Order
model.sel(glm_t,
          glm_rh,
          glm_t_rh,
          glm_vpd)

## Second Order
model.sel(glm_t_2,
          glm_rh_2,
          glm_t_2_rh_2,
          glm_vpd_2)

## All
model.sel(glm_t,
          glm_rh,
          glm_t_rh,
          glm_vpd,
          glm_t_2,
          glm_rh_2,
          glm_t_2_rh_2,
          glm_vpd_2)

```

```{r, prediction-plots}
mod_data_tree_level %>%
    select(asT) %>%
    range()

mod_data_tree_level %>%
    select(asRH) %>%
    range()

mod_data_tree_level %>%
    select(asP) %>%
    range()

mod_data_tree_level %>%
    select(asVPD) %>%
    range()

mod_data_tree_level %>%
    select(dbh_cm) %>%
    range()

plot(ggpredict(glm_t_2_p_rh), facet = TRUE)

plot(ggpredict(glm_t_2_p_2), facet = TRUE)

plot(ggpredict(glm_t_2_p_2, terms = c("asP", "asT")), facet = TRUE)

plot(ggpredict(glm_t_2_p_2, terms = c("asP",  "asT [8, 10, 12, 14]")))

plot(ggpredict(glm_vpd_2_p_2), facet = TRUE)

plot(ggpredict(glm_vpd_2_p_2, terms = c("asVPD",  "asP [5, 50, 100, 150, 190]")))

plot(ggpredict(glm_vpd_2_p_2, terms = c("asP", "asVPD [45, 50, 60, 65, 70]")))


plot(ggpredict(glm_t_rh), facet = TRUE)

plot(ggpredict(glm_t_rh, terms = c("asRH", "asT [8, 10, 12, 14]")))


plot(ggpredict(glm_t_2_rh_2), facet = TRUE)

plot(ggpredict(glm_t_2_rh_2, terms = c("asRH", "asT [8, 10, 12, 14]")))


```

### Residual Plots

```{r, residual-plots}
library(car)

glm_vpd_p_park <- glm(br_status ~ asVPD* asP + dbh_cm + park,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_p_park)

glm_vpd_2_p_2_park <- glm(br_status ~ poly(asVPD, 2) * poly(asP, 2) + dbh_cm + park,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_vpd_2_p_2_park)

residualPlots(glm_vpd_p_park, terms = ~ 1 | park)

residualPlots(glm_vpd_2_p_2_park, terms = ~ 1 | park)

glm_t_2_rh_2_park <- glm(br_status ~ poly(asT, 2) * poly(asRH, 2) + dbh_cm + park,
                   data = mod_data_tree_level,
                   family = binomial
                 )
summary(glm_t_2_rh_2_park)

residualPlots(glm_t_2_rh_2_park, terms = ~ 1 | park)



nbc <- 10
cor_r <- pgirmess::correlog(coords=mod_data_tree_level[,c("long", "lat")],
                            z=glm_vpd_2_p_2$residuals,
                            method="Moran", nbclass=nbc)

cor_r

```

### Variogram

```{r variogram}
library(gstat)
library(sp)

## mod_data_spdf <- SpatialPointsDataFrame(coords = list(lon = mod_data_tree_level$X, lat = mod_data_tree_level$Y), proj4string = toString(crs_lcc), data = mod_data_tree_level)

mod_data_spdf <- as(st_as_sf(mod_data_tree_level, coords = c("X", "Y"), crs = crs_lcc), "Spatial")

bubble(mod_data_spdf, "asVPD")
bubble(mod_data_spdf, "asT")
bubble(mod_data_spdf, "asP")
bubble(mod_data_spdf, "asRH")


t_semivario <- variogram(asT ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(t_semivario)

vpd_semivario <- variogram(asVPD ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(vpd_semivario)

rh_semivario <- variogram(asRH ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(rh_semivario)

p_semivario <- variogram(asP ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(p_semivario)
```

### Confusion Matrix

``` r
library(caret)

set.seed(255)

ctrl <- trainControl(method = "repeatedcv", number = 10, savePredictions = TRUE, repeats = 5)


glm_vpd_2_p_2_train <- train(factor(br_status) ~ poly(asVPD, 2) * poly(asP, 2) + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
    )

glm_t_2_p_2_train <- train(factor(br_status) ~ poly(asT, 2) * poly(asP, 2) + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
    )

glm_p_2_train <- train(factor(br_status) ~ poly(asP, 2) + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
)

glm_t_rh_train <- train(factor(br_status) ~ asT * asRH + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
    )

glm_t_2_rh_2_train <- train(factor(br_status) ~ poly(asT, 2) * poly(asRH, 2) + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
    )

glm_rh_2_train <- train(factor(br_status) ~ poly(asRH, 2) + dbh_cm,
    data = mod_data_tree_level,
    method = "glm", family = "binomial",
    trControl = ctrl, tuneLength = 5
)

print(glm_vpd_2_p_2_train)
print(glm_t_2_p_2_train)
print(glm_p_2_train)
print(glm_t_rh_train)
print(glm_t_2_rh_2_train)
print(glm_rh_2_train)
```

## sdmTMB

``` r
library(sdmTMB)
library(visreg)

## mesh <- make_mesh(mod_data_tree_level, xy_cols = c("X", "Y"), n_knots = 300, type = "kmeans", seed = 255)
## plot(mesh)

## mesh <- make_mesh(mod_data_tree_level,
##                   xy_cols = c("X", "Y"),
##                   fmesher_func = fmesher::fm_mesh_2d_inla,
##                   cutoff = 5,  # minimum triangle edge length
##                   max.edge = c(75, 100), # inner and outer max triangle lengths
##                   offset = c(75,50) # inner and outer border widths
## )
## plot(mesh)

mesh <- make_mesh(mod_data_tree_level, xy_cols = c("X", "Y"), cutoff = 10)
plot(mesh)

## mesh <- make_mesh(mod_data_tree_level,
##                   xy_cols = c("X", "Y"),
##                   fmesher_func = fmesher::fm_mesh_2d_inla,
##                   cutoff = 10,  # minimum triangle edge length
##                   max.edge = c(50, 100), # inner and outer max triangle lengths
##                   offset = c(75,100) # inner and outer border widths
## )
## plot(mesh)

sdm_t_rh <- sdmTMB(
    br_status ~ log_dbh_cm + asT + asRH,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_rh)
 
sdm_t_x_rh <- sdmTMB(
    br_status ~ log_dbh_cm + asT * asRH,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_x_rh)

sdm_t_p <- sdmTMB(
    br_status ~ log_dbh_cm + asT + asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_p)

sdm_t_x_p <- sdmTMB(
    br_status ~ log_dbh_cm + asT * asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_x_p)

sdm_vpd <- sdmTMB(
    br_status ~ log_dbh_cm + asVPD,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_vpd)

sdm_vpd_p <- sdmTMB(
    br_status ~ log_dbh_cm + asVPD + asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_vpd_p)

sdm_p <- sdmTMB(
    br_status ~ log_dbh_cm + asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_p)

## sdm_t_p_rh <- sdmTMB(
##     br_status ~ log_dbh_cm + asT + asRH + asP,
##     data = mod_data_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_t_p_rh)


## Second Order

sdm_t_2_rh <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) + asRH,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_2_rh)

sdm_t_2_x_rh <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) * asRH,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_2_x_rh)

## sdm_t_2_x_rh_1 <- run_extra_optimization(sdm_t_2_x_rh, newton_loops = 100)
## summary(sdm_t_2_x_rh_1)

sdm_vpd_2 <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asVPD, 2),
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_vpd_2)

sdm_vpd_2_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asVPD, 2) + asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_vpd_2_p)


sdm_t_2_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) + asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_2_p)

sdm_t_2_x_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) * asP,
    data = mod_data_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_t_2_x_p)

## sdm_t_2_p_rh <- sdmTMB(
##     br_status ~ log_dbh_cm + poly(asT, 2) + asRH + asP,
##     data = mod_data_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_t_2_p_rh)

## sdm_t_2_x_rh_p <- sdmTMB(
##     br_status ~ log_dbh_cm + poly(asT, 2) * asRH + asP,
##     data = mod_data_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_t_2_x_rh_p)


model.sel(sdm_t_rh, sdm_t_x_rh, sdm_vpd, sdm_vpd_p, sdm_p, sdm_t_2_rh, sdm_t_2_x_rh, sdm_vpd_2, sdm_vpd_2_p, sdm_t_p, sdm_t_2_p, sdm_t_x_p, sdm_t_2_x_p)


m1 <- sdmTMB_cv(br_status ~ 0 + dbh_cm + asT * asRH, data = mod_data_tree_level, mesh = mesh, family = binomial(link = "logit"), k_folds = 4)


glm_t_2_x_p <- glm(br_status ~ poly(asT, 2) * asP, data = mod_data_tree_level, family = binomial(link = "logit"))

mod_data_tree_level$resids_glm <- residuals(glm_t_2_x_p)

qqnorm(residuals(glm_t_2_x_p))
qqline(residuals(glm_t_2_x_p))

ggplot(mod_data_tree_level, aes(X, Y, col = resids_glm)) +
  scale_colour_gradient2() +
  geom_point() +
    coord_fixed()
ggsave("resid_map_glm.png")


glmer_t_2_x_p <- lme4::glmer(br_status ~ poly(asT, 2) * asP + (1 | transect_id), data = mod_data_tree_level, family = binomial(link = "logit"))
summary(glmer_t_2_x_p)

mod_data_tree_level$resids_glmer <- residuals(glmer_t_2_x_p)

qqnorm(residuals(glmer_t_2_x_p))
qqline(residuals(glmer_t_2_x_p))

ggplot(mod_data_tree_level, aes(X, Y, col = resids_glmer)) +
  scale_colour_gradient2() +
  geom_point() +
    coord_fixed()
ggsave("resid_map_glm.png")

mod_data_tree_level$resids <- residuals(sdm_t_2_x_p)

qqnorm(residuals(sdm_t_2_x_p))
qqline(residuals(sdm_t_2_x_p))

ggplot(mod_data_tree_level, aes(X, Y, col = resids)) +
  scale_colour_gradient2() +
  geom_point() +
  coord_fixed()
ggsave("resid_map_sdmTMB.png")


mod_data_tree_level %>%
    select(asP) %>%
    range()


## visreg(sdm_t_2_x_p, xvar = "asT", by = "asP", gg = TRUE, overlay = TRUE, scale = "response")

## visreg(sdm_t_x_rh, xvar = "asRH", by = "asT", gg = TRUE, overlay = TRUE) ## Log Scale

## visreg(sdm_t_x_rh, xvar = "asRH", by = "asT", gg = TRUE, overlay = TRUE, scale = "response")

## visreg(sdm_t_2_x_rh, xvar = "asRH", by = "asT", gg = TRUE, overlay = TRUE, scale = "response")

plot(ggeffect(sdm_t_x_rh), facet = TRUE, add.data = TRUE)

plot(ggeffect(sdm_t_x_rh, terms = c("asT", "asRH [30, 40, 50, 60]")), add.data = TRUE)

plot(ggeffect(sdm_t_x_rh, terms = c("asRH", "asT [8:14 by=2]")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh), facet = TRUE, add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh, terms = c("log_dbh_cm")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh, terms = c("asRH")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh, terms = c("asT")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh, terms = c("asT", "asRH [30,40,50,60]")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_rh, terms = c("asRH", "asT [8:14 by=1]")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p), facet = TRUE, add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("dbh_cm")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("asT")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("asRH")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("asP")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("asT", "asRH [30,40,50,60]")), add.data = TRUE)

## plot(ggeffect(sdm_t_2_x_rh_p, terms = c("asRH", "asT [8:14 by=1]")), add.data = TRUE)

plot(ggeffect(sdm_t_x_p), facet = TRUE, add.data = TRUE)

plot(ggeffect(sdm_t_x_p, terms = c("asT", "asP[25:175 by = 50]")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_p), facet = TRUE, add.data = TRUE)

plot(ggeffect(sdm_t_2_x_p, terms = c("asT", "asP[25:175 by = 50]")), add.data = TRUE)

plot(ggeffect(sdm_t_2_x_p, terms = c("asP", "asT")), add.data = TRUE)



sdmTMB_cv(formula(sdm_t_2_x_p),
          data = mod_data_tree_level,
          mesh = mesh,
          family = binomial(link = "logit")
          )

sdmTMB_cv(formula(sdm_t_2_x_rh),
          data = mod_data_tree_level,
          mesh = mesh,
          family = binomial(link = "logit")
          )

tidy(sdm_t_x_p, conf.int = TRUE)

tidy(sdm_t_2_x_p, conf.int = TRUE)

tidy(sdm_t_x_rh, conf.int = TRUE)

tidy(sdm_t_2_x_rh, conf.int = TRUE)

sim_dat <- simulate(
    sdm_t_2_x_p
)

predictor_dat <- expand.grid(
    X = seq(-419, 657, length.out = 400), Y = seq(4431, 5818, length.out = 400)
)

p <- predict(sdm_t_2_x_p, newdata = predictor_dat, nsim = 500)


saveRDS(sdm_t_2_x_p, file = "sdm_t_2_x_p.RDS")

```

## Conf Matrix

``` r
library(cvms)

set.seed(255)

smp_size <- floor(0.85 * nrow(mod_data_tree_level))

train_ind <- sample(seq_len(nrow(mod_data_tree_level)), size = smp_size)

train <- mod_data_tree_level[train_ind, ]
test <- mod_data_tree_level[-train_ind, ]


sdm_cv <- sdmTMB_cv(formula(sdm_t_2_x_p),
    data = mod_data_tree_level,
    mesh = mesh,
    family = binomial(link = "logit")
)

prediction <- sdm_cv$data %>%
    mutate(cv_predicted_class = if_else(cv_predicted >= 0.5, 1, 0))

confusion_matrix(
    targets = prediction$br_status,
    predictions = prediction$cv_predicted_class
) %>%
    plot_confusion_matrix()

```


## Transect-level

```{r transect-variogram}
library(gstat)
library(sp)

## mod_data_spdf <- SpatialPointsDataFrame(coords = list(lon = mod_data_tree_level$X, lat = mod_data_tree_level$Y), proj4string = toString(crs_lcc), data = mod_data_tree_level)

mod_data_spdf <- as(st_as_sf(mod_data_transect_level, coords = c("X", "Y"), crs = crs_lcc), "Spatial")

bubble(mod_data_spdf, "asVPD")
bubble(mod_data_spdf, "asT")
bubble(mod_data_spdf, "asP")
bubble(mod_data_spdf, "asRH")


t_semivario <- variogram(asT ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(t_semivario)

vpd_semivario <- variogram(asVPD ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(vpd_semivario)

rh_semivario <- variogram(asRH ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(rh_semivario)

p_semivario <- variogram(asP ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(p_semivario)
```

``` r
library(sdmTMB)
library(visreg)

cols = c("recent_br_status", "asT", "asVPD", "asRH", "asP")

ggpairs(mod_data_transect_level, columns = cols)

##mesh <- make_mesh(mod_data_transect_level, xy_cols = c("X", "Y"), n_knots = 50, type = "kmeans", seed = 255)
mesh <- make_mesh(mod_data_transect_level,
                  xy_cols = c("X", "Y"),
                  fmesher_func = fmesher::fm_mesh_2d_inla,
                  cutoff = 10,  # minimum triangle edge length
                  max.edge = c(100, 100), # inner and outer max triangle lengths
                  offset = 100 # inner and outer border widths
)
plot(mesh)

sdm_tr_t_rh <- sdmTMB(
    recent_br_status ~ asT + asRH,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_rh)
 
sdm_tr_t_x_rh <- sdmTMB(
    recent_br_status ~ asT * asRH,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_x_rh)

sdm_tr_t_p <- sdmTMB(
    recent_br_status ~ asT + asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_p)

sdm_tr_t_x_p <- sdmTMB(
    recent_br_status ~ asT * asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_x_p)

sdm_tr_vpd <- sdmTMB(
    recent_br_status ~ asVPD,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_vpd)

sdm_tr_vpd_p <- sdmTMB(
    recent_br_status ~ asVPD + asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_vpd_p)

sdm_tr_p <- sdmTMB(
    recent_br_status ~ asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_p)

## sdm_tr_t_p_rh <- sdmTMB(
##     recent_br_status ~ asT + asRH + asP,
##     data = mod_data_transect_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_tr_t_p_rh)


## Second Order

sdm_tr_t_2_rh <- sdmTMB(
    recent_br_status ~ poly(asT, 2) + asRH,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_2_rh)

sdm_tr_t_2_x_rh <- sdmTMB(
    recent_br_status ~ poly(asT, 2) * asRH,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_2_x_rh)

## sdm_tr_t_2_x_rh_1 <- run_extra_optimization(sdm_tr_t_2_x_rh, newton_loops = 100)
## summary(sdm_tr_t_2_x_rh_1)

sdm_tr_vpd_2 <- sdmTMB(
    recent_br_status ~ poly(asVPD, 2),
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_vpd_2)

sdm_tr_vpd_2_p <- sdmTMB(
    recent_br_status ~ poly(asVPD, 2) + asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_vpd_2_p)


sdm_tr_t_2_p <- sdmTMB(
    recent_br_status ~ poly(asT, 2) + asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_2_p)

sdm_tr_t_2_x_p <- sdmTMB(
    recent_br_status ~ poly(asT, 2) * asP,
    data = mod_data_transect_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_tr_t_2_x_p)

model.sel(sdm_tr_t_rh, sdm_tr_t_x_rh, sdm_tr_vpd, sdm_tr_vpd_p, sdm_tr_p, sdm_tr_t_2_rh, sdm_tr_t_2_x_rh, sdm_tr_vpd_2, sdm_tr_vpd_2_p, sdm_tr_t_p, sdm_tr_t_2_p, sdm_tr_t_x_p, sdm_tr_t_2_x_p)


model.sel(
    sdm_tr_t_rh,
    sdm_tr_t_x_rh,
    sdm_tr_vpd,
    sdm_tr_vpd_p,
    sdm_tr_p,
    sdm_tr_t_p
    ##sdm_tr_t_x_p
)
```


``` r
library(spaMM)

glm_nospatial <- glmer(recent_br_status ~ asT * asRH + (1 | park), data = mod_data_transect_level, family = binomial())

glm_spatial_t_x_rh <- spaMM::fitme(recent_br_status ~ asT * asRH + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())

glm_spatial_vpd <- spaMM::fitme(recent_br_status ~ asVPD + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())

glm_spatial_t_rh <- spaMM::fitme(recent_br_status ~ asT + asRH + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())


glm_spatial_vpd_p <- spaMM::fitme(recent_br_status ~ asVPD + asP + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())

glm_spatial_p <- spaMM::fitme(recent_br_status ~ asP + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())

glm_spatial_t_2 <- spaMM::fitme(recent_br_status ~ poly(asT, 2) + (1 | park) + Matern(1 | Y + X), data = mod_data_transect_level, family = binomial())


```




# Gye Only

``` r
library(gstat)
library(sp)

## mod_data_spdf <- SpatialPointsDataFrame(coords = list(lon = mod_data_tree_level$X, lat = mod_data_tree_level$Y), proj4string = toString(crs_lcc), data = mod_data_tree_level)

mod_data_spdf <- as(st_as_sf(gye_tree_level, coords = c("X", "Y"), crs = crs_lcc), "Spatial")

bubble(mod_data_spdf, "asVPD")
bubble(mod_data_spdf, "asT")
bubble(mod_data_spdf, "asP")
bubble(mod_data_spdf, "asRH")


t_semivario <- variogram(asT ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(t_semivario)

vpd_semivario <- variogram(asVPD ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(vpd_semivario)

rh_semivario <- variogram(asRH ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(rh_semivario)

p_semivario <- variogram(asP ~ 1, data = mod_data_tree_level, locations = ~X+Y)
plot(p_semivario)
```


``` r
gye_tree_level <- mod_data_tree_level %>% filter(network == "gryn")

library(sdmTMB)
library(visreg)

## mesh <- make_mesh(mod_data_tree_level, xy_cols = c("X", "Y"), n_knots = 175, type = "kmeans", seed = 255)
mesh <- make_mesh(gye_tree_level,
                  xy_cols = c("X", "Y"),
                  fmesher_func = fmesher::fm_mesh_2d_inla,
                  cutoff = 25,  # minimum triangle edge length
                  max.edge = c(50, 50), # inner and outer max triangle lengths
                  offset = 50 # inner and outer border widths
)
plot(mesh)

sdm_gye_t_rh <- sdmTMB(
    br_status ~ log_dbh_cm + asT + asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_rh)
 
sdm_gye_t_x_rh <- sdmTMB(
    br_status ~ log_dbh_cm + asT * asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_x_rh)

sdm_gye_t_p <- sdmTMB(
    br_status ~ log_dbh_cm + asT + asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_p)

sdm_gye_t_x_p <- sdmTMB(
    br_status ~ log_dbh_cm + asT * asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_x_p)

sdm_gye_vpd <- sdmTMB(
    br_status ~ log_dbh_cm + asVPD + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_vpd)

sdm_gye_vpd_p <- sdmTMB(
    br_status ~ log_dbh_cm + asVPD + asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_vpd_p)

sdm_gye_p <- sdmTMB(
    br_status ~ log_dbh_cm + asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_p)

## sdm_gye_t_p_rh <- sdmTMB(
##     br_status ~ log_dbh_cm + asT + asRH + asP,
##     data = gye_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_gye_t_p_rh)


## Second Order

sdm_gye_t_2_rh <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) + asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_2_rh)

sdm_gye_t_2_x_rh <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) * asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_2_x_rh)

## sdm_gye_t_2_x_rh_1 <- run_extra_optimization(sdm_gye_t_2_x_rh, newton_loops = 100)
## summary(sdm_gye_t_2_x_rh_1)

sdm_gye_vpd_2 <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asVPD, 2) + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_vpd_2)

sdm_gye_vpd_2_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asVPD, 2) + asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_vpd_2_p)


sdm_gye_t_2_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) + asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_2_p)

sdm_gye_t_2_x_p <- sdmTMB(
    br_status ~ log_dbh_cm + poly(asT, 2) * asP + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit"),
    mesh = mesh,
    spatial = "on"
)
summary(sdm_gye_t_2_x_p)

## sdm_gye_t_2_p_rh <- sdmTMB(
##     br_status ~ log_dbh_cm + poly(asT, 2) + asRH + asP,
##     data = gye_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_gye_t_2_p_rh)

## sdm_gye_t_2_x_rh_p <- sdmTMB(
##     br_status ~ log_dbh_cm + poly(asT, 2) * asRH + asP,
##     data = gye_tree_level,
##     family = binomial(link = "logit"),
##     mesh = mesh,
##     spatial = "on"
## )
## summary(sdm_gye_t_2_x_rh_p)


model.sel(sdm_gye_t_rh,
          sdm_gye_t_x_rh,
          sdm_gye_vpd,
          sdm_gye_vpd_p,
          sdm_gye_p,
          sdm_gye_t_2_rh,
          sdm_gye_t_2_x_rh,
          sdm_gye_vpd_2,
          sdm_gye_vpd_2_p,
          sdm_gye_t_p,
          sdm_gye_t_2_p,
          sdm_gye_t_x_p,
          sdm_gye_t_2_x_p)



mod_data_tree_level$resids <- residuals(sdm_t_2_x_p)

qqnorm(residuals(sdm_t_2_x_p))
qqline(residuals(sdm_t_2_x_p))

ggplot(mod_data_tree_level, aes(X, Y, col = resids)) +
  scale_colour_gradient2() +
  geom_point() +
  coord_fixed()
ggsave("resid_map_sdmTMB.png")

```

### GLMs

``` r
library(lme4)

glm_gye_t <- glmer(br_status ~ log_dbh_cm + asT + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit")
    )
summary(glm_gye_t)

glm_gye_t_rh <- glmer(br_status ~ log_dbh_cm + asT + asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit")
    )
summary(glm_gye_t_rh)


glm_gye_t_x_rh <- glmer(br_status ~ log_dbh_cm + asT * asRH + (1 | transect_id),
    data = gye_tree_level,
    family = binomial(link = "logit")
    )
summary(glm_gye_t_x_rh)

```
